# config.yaml

directories:
  bronze: "/opt/airflow/data/bronze/inmet" 
  silver_rainfall: "/opt/airflow/data/silver/rainfall"
  gold_ts_rainfall: "/opt/airflow/data/gold/rainfall_ts/gold_ts"
  gold_ts_rainfall_artifact: "/opt/airflow/data/gold/rainfall_ts/artifacts"
  monitoramento: "/opt/airflow/data/monitoramento"
  

urls:
  base_url: "https://portal.inmet.gov.br/dadoshistoricos"
  file_pattern: "https://portal.inmet.gov.br/uploads/dadoshistoricos/{AAAA}.zip"

headers:
  User-Agent: "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36"

queries:
  clean_data: |

    SELECT
      CASE WHEN `DATA (YYYY-MM-DD)` IS NULL OR `DATA (YYYY-MM-DD)` = '-9999' THEN NULL ELSE `DATA (YYYY-MM-DD)` END AS `DATA (YYYY-MM-DD)`,
      CASE WHEN `HORA (UTC)` IS NULL OR `HORA (UTC)` = '-9999' THEN NULL ELSE `HORA (UTC)` END AS `HORA (UTC)`,
      CASE WHEN `PRECIPITAÇAO TOTAL, HORÁRIO (mm)` IS NULL OR `PRECIPITAÇAO TOTAL, HORÁRIO (mm)` = '-9999' THEN NULL ELSE `PRECIPITAÇAO TOTAL, HORÁRIO (mm)` END AS `PRECIPITAÇAO TOTAL, HORÁRIO (mm)`,
      CASE WHEN `PRESSAO ATMOSFERICA AO NIVEL DA ESTACAO, HORARIA (mB)` IS NULL OR `PRESSAO ATMOSFERICA AO NIVEL DA ESTACAO, HORARIA (mB)` = '-9999' THEN NULL ELSE `PRESSAO ATMOSFERICA AO NIVEL DA ESTACAO, HORARIA (mB)` END AS `PRESSAO ATMOSFERICA AO NIVEL DA ESTACAO, HORARIA (mB)`,
      CASE WHEN `PRESSAO ATMOSFERICA MAX NA HORA ANT (AUT) (mB)` IS NULL OR `PRESSAO ATMOSFERICA MAX NA HORA ANT (AUT) (mB)` = '-9999' THEN NULL ELSE `PRESSAO ATMOSFERICA MAX NA HORA ANT (AUT) (mB)` END AS `PRESSAO ATMOSFERICA MAX NA HORA ANT (AUT) (mB)`,
      CASE WHEN `PRESSAO ATMOSFERICA MINNA HORA ANT (AUT) (mB)` IS NULL OR `PRESSAO ATMOSFERICA MINNA HORA ANT (AUT) (mB)` = '-9999' THEN NULL ELSE `PRESSAO ATMOSFERICA MINNA HORA ANT (AUT) (mB)` END AS `PRESSAO ATMOSFERICA MINNA HORA ANT (AUT) (mB)`,
      CASE WHEN `RADIACAO GLOBAL (KJ/m²)` IS NULL OR `RADIACAO GLOBAL (KJ/m²)` = '-9999' THEN NULL ELSE `RADIACAO GLOBAL (KJ/m²)` END AS `RADIACAO GLOBAL (KJ/m²)`,
      CASE WHEN `TEMPERATURA DO AR - BULBO SECO, HORARIA (°C)` IS NULL OR `TEMPERATURA DO AR - BULBO SECO, HORARIA (°C)` = '-9999' THEN NULL ELSE `TEMPERATURA DO AR - BULBO SECO, HORARIA (°C)` END AS `TEMPERATURA DO AR - BULBO SECO, HORARIA (°C)`,
      CASE WHEN `TEMPERATURA DO PONTO DE ORVALHO (°C)` IS NULL OR `TEMPERATURA DO PONTO DE ORVALHO (°C)` = '-9999' THEN NULL ELSE `TEMPERATURA DO PONTO DE ORVALHO (°C)` END AS `TEMPERATURA DO PONTO DE ORVALHO (°C)`,
      CASE WHEN `TEMPERATURA MÁXIMA NA HORA ANT (AUT) (°C)` IS NULL OR `TEMPERATURA MÁXIMA NA HORA ANT (AUT) (°C)` = '-9999' THEN NULL ELSE `TEMPERATURA MÁXIMA NA HORA ANT (AUT) (°C)` END AS `TEMPERATURA MÁXIMA NA HORA ANT (AUT) (°C)`,
      CASE WHEN `TEMPERATURA MÍNIMA NA HORA ANT (AUT) (°C)` IS NULL OR `TEMPERATURA MÍNIMA NA HORA ANT (AUT) (°C)` = '-9999' THEN NULL ELSE `TEMPERATURA MÍNIMA NA HORA ANT (AUT) (°C)` END AS `TEMPERATURA MÍNIMA NA HORA ANT (AUT) (°C)`,
      CASE WHEN `TEMPERATURA ORVALHO MAX NA HORA ANT (AUT) (°C)` IS NULL OR `TEMPERATURA ORVALHO MAX NA HORA ANT (AUT) (°C)` = '-9999' THEN NULL ELSE `TEMPERATURA ORVALHO MAX NA HORA ANT (AUT) (°C)` END AS `TEMPERATURA ORVALHO MAX NA HORA ANT (AUT) (°C)`,
      CASE WHEN `TEMPERATURA ORVALHO MINNA HORA ANT (AUT) (°C)` IS NULL OR `TEMPERATURA ORVALHO MINNA HORA ANT (AUT) (°C)` = '-9999' THEN NULL ELSE `TEMPERATURA ORVALHO MINNA HORA ANT (AUT) (°C)` END AS `TEMPERATURA ORVALHO MINNA HORA ANT (AUT) (°C)`,
      CASE WHEN `UMIDADE REL MAX NA HORA ANT (AUT) (%)` IS NULL OR `UMIDADE REL MAX NA HORA ANT (AUT) (%)` = '-9999' THEN NULL ELSE `UMIDADE REL MAX NA HORA ANT (AUT) (%)` END AS `UMIDADE REL MAX NA HORA ANT (AUT) (%)`,
      CASE WHEN `UMIDADE REL MINNA HORA ANT (AUT) (%)` IS NULL OR `UMIDADE REL MINNA HORA ANT (AUT) (%)` = '-9999' THEN NULL ELSE `UMIDADE REL MINNA HORA ANT (AUT) (%)` END AS `UMIDADE REL MINNA HORA ANT (AUT) (%)`,
      CASE WHEN `UMIDADE RELATIVA DO AR, HORARIA (%)` IS NULL OR `UMIDADE RELATIVA DO AR, HORARIA (%)` = '-9999' THEN NULL ELSE `UMIDADE RELATIVA DO AR, HORARIA (%)` END AS `UMIDADE RELATIVA DO AR, HORARIA (%)`,
      CASE WHEN `VENTO, DIREÇAO HORARIA (gr) (° (gr))` IS NULL OR `VENTO, DIREÇAO HORARIA (gr) (° (gr))` = '-9999' THEN NULL ELSE `VENTO, DIREÇAO HORARIA (gr) (° (gr))` END AS `VENTO, DIREÇAO HORARIA (gr) (° (gr))`,
      CASE WHEN `VENTO, RAJADA MAXIMA (m/s)` IS NULL OR `VENTO, RAJADA MAXIMA (m/s)` = '-9999' THEN NULL ELSE `VENTO, RAJADA MAXIMA (m/s)` END AS `VENTO, RAJADA MAXIMA (m/s)`,
      CASE WHEN `VENTO, VELOCIDADE HORARIA (m/s)` IS NULL OR `VENTO, VELOCIDADE HORARIA (m/s)` = '-9999' THEN NULL ELSE `VENTO, VELOCIDADE HORARIA (m/s)` END AS `VENTO, VELOCIDADE HORARIA (m/s)`,
      CASE WHEN `REGIÃO` IS NULL OR `REGIÃO` = '-9999' THEN NULL ELSE `REGIÃO` END AS `REGIÃO`,
      CASE WHEN `UF` IS NULL OR `UF` = '-9999' THEN NULL ELSE `UF` END AS `UF`,
      CASE WHEN `ESTACAO` IS NULL OR `ESTACAO` = '-9999' THEN NULL ELSE `ESTACAO` END AS `ESTACAO`,
      CASE WHEN `CODIGO` IS NULL OR `CODIGO` = '-9999' THEN NULL ELSE `CODIGO` END AS `CODIGO`,
      CASE WHEN `LATITUDE` IS NULL OR `LATITUDE` = '-9999' THEN NULL ELSE `LATITUDE` END AS `LATITUDE`,
      CASE WHEN `LONGITUDE` IS NULL OR `LONGITUDE` = '-9999' THEN NULL ELSE `LONGITUDE` END AS `LONGITUDE`,
      CASE WHEN `ALTITUDE` IS NULL OR `ALTITUDE` = '-9999' THEN NULL ELSE `ALTITUDE` END AS `ALTITUDE`,
      CASE WHEN `DATA_FUNDACAO` IS NULL OR `DATA_FUNDACAO` = '-9999' THEN NULL ELSE `DATA_FUNDACAO` END AS `DATA_FUNDACAO`,
      CASE WHEN `AAAAMM` IS NULL OR `AAAAMM` = '-9999' THEN NULL ELSE `AAAAMM` END AS `AAAAMM`,
      CASE WHEN `year_month` IS NULL OR `year_month` = '-9999' THEN NULL ELSE `year_month` END AS `year_month`
    FROM df

  transform_data: |
    SELECT
      CONCAT(
            SUBSTRING(CAST(`DATA (YYYY-MM-DD)` AS STRING), 1, 4),
            SUBSTRING(CAST(`DATA (YYYY-MM-DD)` AS STRING), 6, 2),
            SUBSTRING(CAST(`DATA (YYYY-MM-DD)` AS STRING), 9, 2),
            '-',
            SUBSTRING(`HORA (UTC)`, 1, 4),
            '-',
            UF,
            '-',
            CODIGO
        ) AS PK_RAINFALL,
      CAST(`DATA (YYYY-MM-DD)` AS DATE) AS DATE_YYYYMMDD,
      `HORA (UTC)` AS HORA,
      `REGIÃO` AS REGIAO,
      `UF`,
      `ESTACAO`,
      `CODIGO`,
      TO_DATE("20"||SUBSTRING(DATA_FUNDACAO, 7, 2) || '-' ||SUBSTRING(DATA_FUNDACAO, 4, 2)|| '-' ||SUBSTRING(DATA_FUNDACAO, 1, 2)) AS DATA_FUNDACAO,
      `AAAAMM`,
      `year_month`,
      CAST(`LATITUDE` AS DECIMAL(15,7)) AS `LATITUDE`,
      CAST(`LONGITUDE` AS DECIMAL(15,7)) AS `LONGITUDE`,
      CAST(`ALTITUDE` AS DECIMAL(15,7)) AS `ALTITUDE`,
      CAST(`PRECIPITAÇAO TOTAL, HORÁRIO (mm)` AS DECIMAL(15,2)) AS PRECIPITACAO,
      CAST(`PRESSAO ATMOSFERICA AO NIVEL DA ESTACAO, HORARIA (mB)` AS DECIMAL(15,2)) AS PA_ESTACAO,
      CAST(`PRESSAO ATMOSFERICA MAX NA HORA ANT (AUT) (mB)` AS DECIMAL(15,2)) AS PA_MAX_ANT,
      CAST(`PRESSAO ATMOSFERICA MINNA HORA ANT (AUT) (mB)` AS DECIMAL(15,2)) AS PA_MIN_ANT,
      CAST(`RADIACAO GLOBAL (KJ/m²)` AS DECIMAL(15,2)) AS RADIACAO_GLOBAL,
      CAST(`TEMPERATURA DO AR - BULBO SECO, HORARIA (°C)` AS DECIMAL(15,2)) AS TEMPERATURA_AR,
      CAST(`TEMPERATURA DO PONTO DE ORVALHO (°C)` AS DECIMAL(15,2)) AS TEMPERATURA_ORVALHO,
      CAST(`TEMPERATURA MÁXIMA NA HORA ANT (AUT) (°C)` AS DECIMAL(15,2)) AS TEMPERATURA_MAX_ANT,
      CAST(`TEMPERATURA MÍNIMA NA HORA ANT (AUT) (°C)` AS DECIMAL(15,2)) AS TEMPERATURA_MIN_ANT,
      CAST(`TEMPERATURA ORVALHO MAX NA HORA ANT (AUT) (°C)` AS DECIMAL(15,2)) AS TEMPERATURA_MAX_ORVALHO_ANT,
      CAST(`TEMPERATURA ORVALHO MINNA HORA ANT (AUT) (°C)` AS DECIMAL(15,2)) AS TEMPERATURA_MIN_ORVALHO_ANT,
      CAST(`UMIDADE REL MAX NA HORA ANT (AUT) (%)` AS DECIMAL(15,2)) AS UMIDADE_REL_MAX_ANT,
      CAST(`UMIDADE REL MINNA HORA ANT (AUT) (%)` AS DECIMAL(15,2)) AS UMIDADE_REL_MIN_ANT,
      CAST(`UMIDADE RELATIVA DO AR, HORARIA (%)` AS DECIMAL(15,2)) AS UMIDADE_REL_AR,
      CAST(`VENTO, DIREÇAO HORARIA (gr) (° (gr))` AS DECIMAL(15,2)) AS VENTO_DIRECAO_HORARIA,
      CAST(`VENTO, RAJADA MAXIMA (m/s)` AS DECIMAL(15,2)) AS VENTO_RAJADA_MAX,
      CAST(`VENTO, VELOCIDADE HORARIA (m/s)` AS DECIMAL(15,2)) AS VENTO_VELOCIDADE_HORARIA
    FROM df2
  monitoramento: |
    SELECT
      REGIAO AS regiao,
      UF AS uf,
      COUNT(ESTACAO) AS quantidade_estacoes,
      SUM(PRECIPITACAO) AS volumetria_safra
    FROM df3
    WHERE DATA_FUNDACAO IS NOT NULL
    GROUP BY REGIAO, UF

  serie_temporal: |
    SELECT AAAAMM, 
           SUM(PRECIPITACAO) AS PRECIPITACAO_MENSAL
    FROM rainfall_view 
    WHERE UF = "PA" 
      AND ESTACAO = "BELEM"
    GROUP BY AAAAMM
    ORDER BY AAAAMM ASC
